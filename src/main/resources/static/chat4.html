<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÏõπÏÜåÏºì Í≤åÏûÑ ÌÖåÏä§Ìä∏</title>
    <!-- Íµ¨Î≤ÑÏ†Ñ STOMP ÎùºÏù¥Î∏åÎü¨Î¶¨ ÏÇ¨Ïö© -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <script>
        // ÎùºÏù¥Î∏åÎü¨Î¶¨ Î°úÎî© ÌôïÏù∏
        console.log('SockJS loaded:', typeof SockJS !== 'undefined');
        console.log('Stomp loaded:', typeof Stomp !== 'undefined');
        console.log('Stomp.over available:', typeof Stomp !== 'undefined' && typeof Stomp.over === 'function');
    </script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        h1 {
            text-align: center;
            color: #4a5568;
            margin-bottom: 30px;
            font-size: 2em;
        }

        .section {
            background: #f7fafc;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #4299e1;
        }

        .game-section {
            border-left-color: #48bb78;
        }

        .question-section {
            border-left-color: #ed8936;
        }

        .answer-section {
            border-left-color: #9f7aea;
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
        }

        label {
            font-weight: bold;
            min-width: 100px;
            color: #2d3748;
        }

        input[type="text"], input[type="number"], textarea, select {
            flex: 1;
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
            font-family: inherit;
        }

        textarea {
            min-height: 80px;
            resize: vertical;
        }

        input[type="text"]:focus, input[type="number"]:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #4299e1;
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .connect-btn {
            background: #48bb78;
            color: white;
        }

        .connect-btn:hover:not(.disabled) {
            background: #38a169;
            transform: translateY(-2px);
        }

        .disconnect-btn {
            background: #f56565;
            color: white;
        }

        .disconnect-btn:hover:not(.disabled) {
            background: #e53e3e;
            transform: translateY(-2px);
        }

        .send-btn {
            background: #4299e1;
            color: white;
        }

        .send-btn:hover:not(.disabled) {
            background: #3182ce;
            transform: translateY(-2px);
        }

        .game-btn {
            background: #ed8936;
            color: white;
        }

        .game-btn:hover:not(.disabled) {
            background: #dd6b20;
            transform: translateY(-2px);
        }

        .answer-btn {
            background: #9f7aea;
            color: white;
        }

        .answer-btn:hover:not(.disabled) {
            background: #805ad5;
            transform: translateY(-2px);
        }

        .messages {
            height: 300px;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            background: white;
        }

        .message {
            padding: 8px 12px;
            margin-bottom: 8px;
            border-radius: 8px;
            animation: fadeIn 0.3s ease-in;
        }

        .message.sent {
            background: #bee3f8;
            text-align: right;
            margin-left: 50px;
        }

        .message.received {
            background: #f0fff4;
            margin-right: 50px;
        }

        .message.system {
            background: #fed7d7;
            text-align: center;
            font-style: italic;
            color: #e53e3e;
        }

        .message.game {
            background: #fef5e7;
            border-left: 4px solid #ed8936;
            font-weight: bold;
            color: #744210;
        }

        .message.question {
            background: #e6fffa;
            border-left: 4px solid #38b2ac;
            color: #234e52;
        }

        .message.answer {
            background: #faf5ff;
            border-left: 4px solid #9f7aea;
            color: #553c9a;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .status {
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-weight: bold;
            text-align: center;
        }

        .status.connected {
            background: #c6f6d5;
            color: #22543d;
        }

        .status.disconnected {
            background: #fed7d7;
            color: #742a2a;
        }

        .game-status {
            background: #e6fffa;
            border: 2px solid #38b2ac;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .game-status h4 {
            margin: 0 0 10px 0;
            color: #234e52;
        }

        .game-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            font-size: 14px;
        }

        .game-info-item {
            background: white;
            padding: 8px 12px;
            border-radius: 6px;
            border-left: 3px solid #38b2ac;
        }

        .message-form {
            display: flex;
            gap: 10px;
        }

        #messageInput {
            flex: 1;
        }

        .disabled {
            opacity: 0.5;
            pointer-events: none;
        }

        .button-row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .answer-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .answer-buttons button {
            flex: 1;
            min-width: 120px;
        }

        .correct-btn {
            background: #48bb78;
            color: white;
        }

        .incorrect-btn {
            background: #f56565;
            color: white;
        }

        .irrelevant-btn {
            background: #a0aec0;
            color: white;
        }

        .question-info {
            margin-top: 15px;
            padding: 15px;
            background: #f0f0f0;
            border-radius: 8px;
            border-left: 4px solid #38b2ac;
        }

        .question-info.active {
            background: #e6fffa;
            border-left-color: #38b2ac;
        }

        .question-info h5 {
            margin: 0 0 10px 0;
            color: #234e52;
            font-size: 14px;
        }

        .question-text {
            font-size: 13px;
            color: #2d3748;
            margin-bottom: 8px;
            padding: 8px;
            background: white;
            border-radius: 4px;
            font-style: italic;
        }

        .question-meta {
            font-size: 12px;
            color: #666;
        }

        @media (max-width: 768px) {
            .two-column {
                grid-template-columns: 1fr;
            }

            .button-row, .answer-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
<div class="container">
    <h1>üéÆ ÏõπÏÜåÏºì Í≤åÏûÑ ÌÖåÏä§Ìä∏</h1>

    <div class="section">
        <h3>Ïó∞Í≤∞ ÏÑ§Ï†ï</h3>
        <div class="input-group">
            <label>ÏÑúÎ≤Ñ URL:</label>
            <input type="text" id="serverUrl" value="http://localhost:8080/ws" placeholder="ÏõπÏÜåÏºì ÏÑúÎ≤Ñ URL">
        </div>
        <div class="input-group">
            <label>Î∞© ID:</label>
            <input type="number" id="roomId" value="1" placeholder="Î∞© ID">
        </div>
        <div class="input-group">
            <label>ÏÇ¨Ïö©Ïûê ID:</label>
            <input type="number" id="userId" value="1" placeholder="ÏÇ¨Ïö©Ïûê ID (Ïà´Ïûê)">
        </div>
        <div class="input-group">
            <label>ÏÇ¨Ïö©ÏûêÎ™Ö:</label>
            <input type="text" id="username" value="ÌÖåÏä§ÌÑ∞1" placeholder="ÏÇ¨Ïö©ÏûêÎ™Ö (ÌëúÏãúÏö©)">
        </div>
        <div class="button-row">
            <button id="connectBtn" class="connect-btn">üîó Ïó∞Í≤∞</button>
            <button id="disconnectBtn" class="disconnect-btn disabled">‚ùå Ïó∞Í≤∞ Ìï¥Ï†ú</button>
        </div>
    </div>

    <div id="status" class="status disconnected">Ïó∞Í≤∞ÎêòÏßÄ ÏïäÏùå</div>

    <div id="gameStatus" class="game-status" style="display: none;">
        <h4>üéÆ Í≤åÏûÑ ÏÉÅÌÉú</h4>
        <div class="game-info">
            <div class="game-info-item">
                <strong>ÌòÑÏû¨ ÏßàÎ¨∏Ïûê:</strong> <span id="currentQuestioner">-</span>
            </div>
            <div class="game-info-item">
                <strong>Îã§Ïùå ÏßàÎ¨∏Ïûê:</strong> <span id="nextQuestioner">-</span>
            </div>
            <div class="game-info-item">
                <strong>ÎÇ®ÏùÄ ÏßàÎ¨∏:</strong> <span id="remainingQuestions">-</span>
            </div>
            <div class="game-info-item">
                <strong>Í≤åÏûÑ ÏãúÍ∞Ñ:</strong> <span id="gameTime">-</span>
            </div>
        </div>
    </div>

    <div class="two-column">
        <div class="section">
            <h3>üí¨ Ï±ÑÌåÖ Î∞è Î©îÏãúÏßÄ</h3>
            <div id="messages" class="messages"></div>
            <div class="message-form">
                <input type="text" id="messageInput" placeholder="Ï±ÑÌåÖ Î©îÏãúÏßÄÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî..." disabled>
                <button id="sendBtn" class="send-btn disabled">Ï†ÑÏÜ°</button>
            </div>
        </div>

        <div class="section game-section">
            <h3>üéÆ Í≤åÏûÑ Ï†úÏñ¥</h3>
            <div class="button-row">
                <button id="gameStartBtn" class="game-btn disabled">üöÄ Í≤åÏûÑ ÏãúÏûë</button>
                <button id="gameEndBtn" class="disconnect-btn disabled">üõë Í≤åÏûÑ Ï¢ÖÎ£å</button>
            </div>

            <div class="section question-section" style="margin-top: 20px;">
                <h4>‚ùì ÏßàÎ¨∏ Ï†úÏ∂ú</h4>
                <div class="input-group">
                    <label>ÏßàÎ¨∏:</label>
                    <textarea id="questionInput" placeholder="ÏßàÎ¨∏ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî..." disabled rows="3"></textarea>
                </div>
                <button id="questionBtn" class="game-btn disabled">üìù ÏßàÎ¨∏ Ï†úÏ∂ú</button>
            </div>

            <div class="section answer-section" style="margin-top: 20px;">
                <h4>üí¨ ÎãµÎ≥Ä Ï†úÏ∂ú (Ï∂úÏ†úÏûê Ï†ÑÏö©)</h4>
                <p style="font-size: 12px; color: #666; margin-bottom: 15px;">
                    Î∞õÏùÄ ÏßàÎ¨∏Ïóê ÎåÄÌï¥ ÎãµÎ≥ÄÌïòÏÑ∏Ïöî. ÎãµÎ≥ÄÌï† ÏßàÎ¨∏Ïù¥ ÏïÑÎûòÏóê ÌëúÏãúÎê©ÎãàÎã§.
                </p>

                <div id="questionInfo" class="question-info">
                    <h5>üìã ÎãµÎ≥ÄÌï† ÏßàÎ¨∏</h5>
                    <div id="questionDisplay" class="question-text">ÏßàÎ¨∏Ïù¥ ÏóÜÏäµÎãàÎã§</div>
                    <div id="questionMeta" class="question-meta">ÏßàÎ¨∏Ïûê: - | ÏãúÍ∞Ñ: -</div>
                </div>

                <div class="answer-buttons">
                    <button id="correctBtn" class="answer-btn correct-btn disabled">‚úÖ ÎßûÏäµÎãàÎã§</button>
                    <button id="incorrectBtn" class="answer-btn incorrect-btn disabled">‚ùå ÌãÄÎ†∏ÏäµÎãàÎã§</button>
                    <button id="irrelevantBtn" class="answer-btn irrelevant-btn disabled">ü§∑ ÏÉÅÍ¥ÄÏóÜÏùå</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let stompClient = null;
    let connected = false;
    let currentRoomId = null;
    let currentUserId = null;
    let currentUsername = null;
    let gameStartTime = null;

    // ÏßàÎ¨∏-ÎãµÎ≥Ä Ïó∞ÎèôÏùÑ ÏúÑÌïú Î≥ÄÏàòÎì§
    let currentQuestion = null;  // ÌòÑÏû¨ ÎãµÎ≥ÄÌï¥Ïïº Ìï† ÏßàÎ¨∏ Ï†ïÎ≥¥

    // DOM ÏöîÏÜåÎì§
    const connectBtn = document.getElementById('connectBtn');
    const disconnectBtn = document.getElementById('disconnectBtn');
    const sendBtn = document.getElementById('sendBtn');
    const gameStartBtn = document.getElementById('gameStartBtn');
    const gameEndBtn = document.getElementById('gameEndBtn');
    const questionBtn = document.getElementById('questionBtn');
    const correctBtn = document.getElementById('correctBtn');
    const incorrectBtn = document.getElementById('incorrectBtn');
    const irrelevantBtn = document.getElementById('irrelevantBtn');
    const messageInput = document.getElementById('messageInput');
    const questionInput = document.getElementById('questionInput');
    const messages = document.getElementById('messages');
    const status = document.getElementById('status');
    const gameStatus = document.getElementById('gameStatus');

    // ÏßàÎ¨∏ Ï†ïÎ≥¥ ÌëúÏãú ÏöîÏÜåÎì§
    const questionInfo = document.getElementById('questionInfo');
    const questionDisplay = document.getElementById('questionDisplay');
    const questionMeta = document.getElementById('questionMeta');

    // Í≤åÏûÑ ÏÉÅÌÉú ÏöîÏÜåÎì§
    const currentQuestionerSpan = document.getElementById('currentQuestioner');
    const nextQuestionerSpan = document.getElementById('nextQuestioner');
    const remainingQuestionsSpan = document.getElementById('remainingQuestions');
    const gameTimeSpan = document.getElementById('gameTime');

    // Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà
    connectBtn.addEventListener('click', connect);
    disconnectBtn.addEventListener('click', disconnect);
    sendBtn.addEventListener('click', sendMessage);
    gameStartBtn.addEventListener('click', startGame);
    gameEndBtn.addEventListener('click', endGame);
    questionBtn.addEventListener('click', sendQuestion);
    correctBtn.addEventListener('click', () => sendAnswer('CORRECT'));
    incorrectBtn.addEventListener('click', () => sendAnswer('INCORRECT'));
    irrelevantBtn.addEventListener('click', () => sendAnswer('IRRELEVANT'));

    messageInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });

    questionInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && e.ctrlKey) {
            sendQuestion();
        }
    });

    function connect() {
        // ÎùºÏù¥Î∏åÎü¨Î¶¨ Î°úÎî© ÌôïÏù∏
        if (typeof SockJS === 'undefined') {
            addMessage('SockJS ÎùºÏù¥Î∏åÎü¨Î¶¨Í∞Ä Î°úÎìúÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.', 'system');
            return;
        }

        if (typeof Stomp === 'undefined') {
            addMessage('Stomp ÎùºÏù¥Î∏åÎü¨Î¶¨Í∞Ä Î°úÎìúÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.', 'system');
            return;
        }

        const serverUrl = document.getElementById('serverUrl').value;
        const roomId = document.getElementById('roomId').value;
        const userId = document.getElementById('userId').value;
        const username = document.getElementById('username').value;

        if (!serverUrl || !roomId || !userId || !username) {
            alert('Î™®Îì† ÌïÑÎìúÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî!');
            return;
        }

        currentRoomId = roomId;
        currentUserId = parseInt(userId);
        currentUsername = username;

        addMessage(`${serverUrl}Ïóê Ïó∞Í≤∞ ÏãúÎèÑ Ï§ë...`, 'system');

        try {
            const socket = new SockJS(serverUrl);
            stompClient = Stomp.over(socket);

            // ÎîîÎ≤ÑÍ∑∏ ÏÑ§Ï†ï
            stompClient.debug = function(str) {
                if (str.includes('Connected') || str.includes('ERROR') || str.includes('DISCONNECT')) {
                    console.log('STOMP: ' + str);
                }
            };

            // ÌïòÌä∏ÎπÑÌä∏ ÏÑ§Ï†ï
            stompClient.heartbeat.outgoing = 20000;
            stompClient.heartbeat.incoming = 20000;

            // STOMP Ïó∞Í≤∞
            stompClient.connect({
                    userId: currentUserId.toString(), // ‚úÖ userIdÎ•º Ìó§ÎçîÏóê Îã¥ÏïÑ ÏÑúÎ≤ÑÎ°ú Ï†ÑÎã¨
                    'user-id': currentUserId.toString(), // Îã§Î•∏ ÌòïÌÉúÎ°úÎèÑ ÏãúÎèÑ
                    'X-User-Id': currentUserId.toString() // Ìó§Îçî ÌòïÌÉúÎ°úÎèÑ ÏãúÎèÑ
                },
                function(frame) {
                    console.log('STOMP Connected: ' + frame);
                    console.log('Ïó∞Í≤∞Îêú ÏÇ¨Ïö©Ïûê ID:', currentUserId);
                    console.log('Ïó∞Í≤∞ Ìó§Îçî:', frame.headers);
                    connected = true;
                    updateUI();
                    addMessage(`Î∞© ${roomId}Ïóê Ïó∞Í≤∞ ÏÑ±Í≥µ!`, 'system');
                    subscribeToChannels();
                },
                function(error) {
                    console.log('STOMP Connection error: ', error);
                    addMessage('STOMP Ïó∞Í≤∞ Ïã§Ìå®: ' + (error.headers ? error.headers.message : error), 'system');
                    connected = false;
                    updateUI();
                }
            );

        } catch (error) {
            console.error('Ïó∞Í≤∞ Ï§ë ÏóêÎü¨:', error);
            addMessage('Ïó∞Í≤∞ Ï§ë ÏóêÎü¨: ' + error.message, 'system');
            connected = false;
            updateUI();
        }
    }

    function subscribeToChannels() {
        try {
            // Ï±ÑÌåÖ Íµ¨ÎèÖ
            stompClient.subscribe(`/topic/chat/${currentRoomId}`, function(message) {
                const chatMessage = JSON.parse(message.body);
                const messageType = chatMessage.username === currentUsername ? 'sent' : 'received';
                addMessage(`${chatMessage.username}: ${chatMessage.content}`, messageType);
            });

            // Í≤åÏûÑ ÏãúÏûë ÏïåÎ¶º Íµ¨ÎèÖ
            stompClient.subscribe(`/topic/game/${currentRoomId}/game-started`, function(message) {
                const gameStartMessage = JSON.parse(message.body);
                addMessage(`üéÆ Í≤åÏûÑ ÏãúÏûë! ${gameStartMessage.message || 'Í≤åÏûÑÏù¥ ÏãúÏûëÎêòÏóàÏäµÎãàÎã§!'}`, 'game');
                handleGameStart(gameStartMessage);
            });

            // Í≤åÏûÑ Ï¢ÖÎ£å ÏïåÎ¶º Íµ¨ÎèÖ
            stompClient.subscribe(`/topic/game/end/${currentRoomId}`, function(message) {
                const gameEndMessage = JSON.parse(message.body);
                addMessage(`üõë Í≤åÏûÑ Ï¢ÖÎ£å: ${gameEndMessage.message}`, 'game');
                handleGameEnd(gameEndMessage);
            });

            // ÏßàÎ¨∏ Ï†ÑÏÜ° ÏÑ±Í≥µ ÏïåÎ¶º Íµ¨ÎèÖ - Îã§ÏñëÌïú Í≤ΩÎ°ú ÏãúÎèÑÌï¥ÏÑú Ïñ¥Îñ§ Í≤ΩÎ°úÎ°ú Ïò§ÎäîÏßÄ ÌôïÏù∏
            console.log('Íµ¨ÎèÖ ÏãúÏûë - ÌòÑÏû¨ ÏÇ¨Ïö©Ïûê ID:', currentUserId, 'Î∞© ID:', currentRoomId);

            // 1. ÌëúÏ§Ä user Í≤ΩÎ°ú
            stompClient.subscribe(`/user/topic/game/${currentRoomId}/question-send`, function(message) {
                const questionResponse = JSON.parse(message.body);
                console.log('!!!!!!!ÏßàÎ¨∏ Í¥ÄÎ†® ÎÇ¥Ïö© (user Í≤ΩÎ°ú)', questionResponse);
                addMessage(`‚úÖ ÏßàÎ¨∏Ïù¥ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Ï†ÑÏÜ°ÎêòÏóàÏäµÎãàÎã§! (user Í≤ΩÎ°ú)`, 'system');
            });

            // 2. user queue Í≤ΩÎ°ú (ÎïåÎ°úÎäî Ïù¥Î†áÍ≤å Ïò¨ ÏàòÎèÑ ÏûàÏùå)
            stompClient.subscribe(`/user/queue/topic/game/${currentRoomId}/question-send`, function(message) {
                const questionResponse = JSON.parse(message.body);
                console.log('!!!!!!!ÏßàÎ¨∏ Í¥ÄÎ†® ÎÇ¥Ïö© (queue Í≤ΩÎ°ú)', questionResponse);
                addMessage(`‚úÖ ÏßàÎ¨∏Ïù¥ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Ï†ÑÏÜ°ÎêòÏóàÏäµÎãàÎã§! (queue Í≤ΩÎ°ú)`, 'system');
            });

            // 3. ÏßÅÏ†ëÏ†ÅÏù∏ topic Í≤ΩÎ°ú (ÌòπÏãú Î∏åÎ°úÎìúÏ∫êÏä§Ìä∏Î°ú Ïò§Îäî Í≤ΩÏö∞)
            stompClient.subscribe(`/topic/game/${currentRoomId}/question-send`, function(message) {
                const questionResponse = JSON.parse(message.body);
                console.log('!!!!!!!ÏßàÎ¨∏ Í¥ÄÎ†® ÎÇ¥Ïö© (topic Í≤ΩÎ°ú)', questionResponse);
                addMessage(`‚úÖ ÏßàÎ¨∏Ïù¥ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Ï†ÑÏÜ°ÎêòÏóàÏäµÎãàÎã§! (topic Í≤ΩÎ°ú)`, 'system');
            });

            // ÎãµÎ≥Ä Ï†ÑÏÜ° ÏÑ±Í≥µ ÏïåÎ¶º Íµ¨ÎèÖ - Îã§ÏñëÌïú Í≤ΩÎ°ú ÏãúÎèÑ
            // 1. ÌëúÏ§Ä user Í≤ΩÎ°ú
            stompClient.subscribe(`/user/topic/game/${currentRoomId}/answer-send`, function(message) {
                const answerResponse = JSON.parse(message.body);
                console.log('ÎãµÎ≥Ä Ï†ÑÏÜ° ÏÑ±Í≥µ (user Í≤ΩÎ°ú)', answerResponse);
                addMessage(`‚úÖ ÎãµÎ≥ÄÏù¥ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Ï†ÑÏÜ°ÎêòÏóàÏäµÎãàÎã§! (user Í≤ΩÎ°ú)`, 'system');
                clearCurrentQuestion();
            });

            // 2. user queue Í≤ΩÎ°ú
            stompClient.subscribe(`/user/queue/topic/game/${currentRoomId}/answer-send`, function(message) {
                const answerResponse = JSON.parse(message.body);
                console.log('ÎãµÎ≥Ä Ï†ÑÏÜ° ÏÑ±Í≥µ (queue Í≤ΩÎ°ú)', answerResponse);
                addMessage(`‚úÖ ÎãµÎ≥ÄÏù¥ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Ï†ÑÏÜ°ÎêòÏóàÏäµÎãàÎã§! (queue Í≤ΩÎ°ú)`, 'system');
                clearCurrentQuestion();
            });

            // 3. ÏßÅÏ†ëÏ†ÅÏù∏ topic Í≤ΩÎ°ú
            stompClient.subscribe(`/topic/game/${currentRoomId}/answer-send`, function(message) {
                const answerResponse = JSON.parse(message.body);
                console.log('ÎãµÎ≥Ä Ï†ÑÏÜ° ÏÑ±Í≥µ (topic Í≤ΩÎ°ú)', answerResponse);
                addMessage(`‚úÖ ÎãµÎ≥ÄÏù¥ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Ï†ÑÏÜ°ÎêòÏóàÏäµÎãàÎã§! (topic Í≤ΩÎ°ú)`, 'system');
                clearCurrentQuestion();
            });

            // ÏßàÎ¨∏ Î∏åÎ°úÎìúÏ∫êÏä§Ìä∏ Íµ¨ÎèÖ (Î™®Îì† Ï∞∏Ïó¨ÏûêÏö©)
            stompClient.subscribe(`/topic/game/${currentRoomId}/chat`, function(message) {
                const gameMessage = JSON.parse(message.body);

                if (gameMessage.type === 'question') {
                    const questionData = gameMessage.data;
                    const questionText = questionData.questionRequestDto.message;
                    const questionerId = questionData.questionRequestDto.senderId;

                    addMessage(`‚ùì ÏßàÎ¨∏: ${questionText}`, 'question');

                    // Ï∂úÏ†úÏûêÏù∏ Í≤ΩÏö∞ ÏßàÎ¨∏ Ï†ïÎ≥¥ Ï†ÄÏû•
                    if (questionData.hostId === currentUserId) {
                        setCurrentQuestion(questionText, questionerId);
                        addMessage(`üìã ÏÉàÎ°úÏö¥ ÏßàÎ¨∏Ïù¥ ÎèÑÏ∞©ÌñàÏäµÎãàÎã§! ÎãµÎ≥Ä ÏÑπÏÖòÏùÑ ÌôïÏù∏ÌïòÏÑ∏Ïöî.`, 'system');
                    }

                    updateGameState(questionData);
                } else if (gameMessage.type === 'answer') {
                    const answerData = gameMessage.data;
                    const answerText = getAnswerText(answerData.answerResponseDto.message);
                    addMessage(`üí¨ ÎãµÎ≥Ä: ${answerText}`, 'answer');
                    updateGameState(answerData);
                }
            });

            // ÏóêÎü¨ Î©îÏãúÏßÄ Íµ¨ÎèÖ
            stompClient.subscribe(`/sub/user/${currentUserId}/error`, function(message) {
                const errorMessage = JSON.parse(message.body);
                addMessage(`‚ùå ÏóêÎü¨: ${errorMessage.message || errorMessage}`, 'system');
            });

            addMessage('Î™®Îì† Ï±ÑÎÑê Íµ¨ÎèÖ ÏôÑÎ£å', 'system');

        } catch (error) {
            console.error('Íµ¨ÎèÖ Ï§ë ÏóêÎü¨:', error);
            addMessage('Íµ¨ÎèÖ Ïã§Ìå®: ' + error.message, 'system');
        }
    }

    function disconnect() {
        if (stompClient !== null && connected) {
            stompClient.disconnect();
            addMessage('Ïó∞Í≤∞Ïù¥ Ìï¥Ï†úÎêòÏóàÏäµÎãàÎã§.', 'system');
        }
        connected = false;
        gameStartTime = null;
        currentQuestion = null;  // ÏßàÎ¨∏ Ï†ïÎ≥¥ Ï¥àÍ∏∞Ìôî
        updateUI();
        hideGameStatus();
        clearCurrentQuestion();
    }

    function sendMessage() {
        const messageContent = messageInput.value.trim();
        if (messageContent && connected) {
            const chatMessage = {
                username: currentUsername,
                content: messageContent
            };

            stompClient.send(`/topic/chat/${currentRoomId}`, {}, JSON.stringify(chatMessage));
            messageInput.value = '';
        }
    }

    function startGame() {
        if (currentRoomId && currentUserId) {
            addMessage(`üéÆ Í≤åÏûÑ ÏãúÏûëÏùÑ ÏöîÏ≤≠Ìï©ÎãàÎã§...`, 'sent');

            try {
                stompClient.send(
                    `/app/game/${currentRoomId}/start`
                );
                addMessage(`‚úÖ Í≤åÏûÑ ÏãúÏûë ÏöîÏ≤≠ÏùÑ ÏÑúÎ≤ÑÎ°ú Ï†ÑÏÜ°ÌñàÏäµÎãàÎã§.`, 'system');
            } catch (error) {
                console.error('Í≤åÏûÑ ÏãúÏûë Î©îÏãúÏßÄ Ï†ÑÏÜ° Ï§ë Ïò§Î•ò:', error);
                addMessage(`‚ùå Í≤åÏûÑ ÏãúÏûë ÏöîÏ≤≠ Ïã§Ìå®: ${error.message}`, 'system');
            }
        }
    }

    function sendQuestion() {
        const questionContent = questionInput.value.trim();
        if (!questionContent) {
            alert('ÏßàÎ¨∏ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî!');
            return;
        }

        if (!connected) {
            alert('Î®ºÏ†Ä ÏõπÏÜåÏºìÏóê Ïó∞Í≤∞Ìï¥Ï£ºÏÑ∏Ïöî!');
            return;
        }

        addMessage(`üìù ÏßàÎ¨∏ Ï†úÏ∂ú: "${questionContent}"`, 'sent');

        try {
            stompClient.send(
                `/app/game/${currentRoomId}/question`,
                {},
                questionContent // StringÏùÑ ÏßÅÏ†ë Ï†ÑÏÜ°
            );
            questionInput.value = '';
            addMessage(`‚úÖ ÏßàÎ¨∏ÏùÑ ÏÑúÎ≤ÑÎ°ú Ï†ÑÏÜ°ÌñàÏäµÎãàÎã§.`, 'system');
        } catch (error) {
            console.error('ÏßàÎ¨∏ Ï†ÑÏÜ° Ï§ë Ïò§Î•ò:', error);
            addMessage(`‚ùå ÏßàÎ¨∏ Ï†ÑÏÜ° Ïã§Ìå®: ${error.message}`, 'system');
        }
    }

    function sendAnswer(answerStatus) {
        if (!connected) {
            alert('Î®ºÏ†Ä ÏõπÏÜåÏºìÏóê Ïó∞Í≤∞Ìï¥Ï£ºÏÑ∏Ïöî!');
            return;
        }

        if (!currentQuestion) {
            alert('ÎãµÎ≥ÄÌï† ÏßàÎ¨∏Ïù¥ ÏóÜÏäµÎãàÎã§!');
            return;
        }

        const answerText = getAnswerText(answerStatus);
        addMessage(`üí¨ ÎãµÎ≥Ä Ï†úÏ∂ú: "${answerText}" (ÏßàÎ¨∏: "${currentQuestion.question}")`, 'sent');

        try {
            // AnswerRequestDto ÌòïÌÉúÎ°ú Ï†ÑÏÜ°
            const answerRequest = {
                questionerId: currentQuestion.questionerId,
                question: currentQuestion.question,
                answer: answerStatus
            };

            console.log('ÎãµÎ≥Ä ÏöîÏ≤≠ Îç∞Ïù¥ÌÑ∞:', answerRequest);

            stompClient.send(
                `/app/game/${currentRoomId}/answer`,
                {},
                JSON.stringify(answerRequest)
            );
            addMessage(`‚úÖ ÎãµÎ≥ÄÏùÑ ÏÑúÎ≤ÑÎ°ú Ï†ÑÏÜ°ÌñàÏäµÎãàÎã§.`, 'system');
        } catch (error) {
            console.error('ÎãµÎ≥Ä Ï†ÑÏÜ° Ï§ë Ïò§Î•ò:', error);
            addMessage(`‚ùå ÎãµÎ≥Ä Ï†ÑÏÜ° Ïã§Ìå®: ${error.message}`, 'system');
        }
    }

    function setCurrentQuestion(questionText, questionerId) {
        currentQuestion = {
            question: questionText,
            questionerId: questionerId,
            receivedAt: new Date()
        };
        updateQuestionDisplay();
        console.log('ÏßàÎ¨∏ Ï†ïÎ≥¥ Ï†ÄÏû•:', currentQuestion);
    }

    function clearCurrentQuestion() {
        currentQuestion = null;
        updateQuestionDisplay();
    }

    function updateQuestionDisplay() {
        if (currentQuestion) {
            questionDisplay.textContent = `"${currentQuestion.question}"`;
            questionMeta.textContent = `ÏßàÎ¨∏Ïûê ID: ${currentQuestion.questionerId} | ÏãúÍ∞Ñ: ${currentQuestion.receivedAt.toLocaleTimeString()}`;
            questionInfo.classList.add('active');
        } else {
            questionDisplay.textContent = 'ÏßàÎ¨∏Ïù¥ ÏóÜÏäµÎãàÎã§';
            questionMeta.textContent = 'ÏßàÎ¨∏Ïûê: - | ÏãúÍ∞Ñ: -';
            questionInfo.classList.remove('active');
        }
    }

    function getAnswerText(answerStatus) {
        switch(answerStatus) {
            case 'CORRECT': return '‚úÖ ÎßûÏäµÎãàÎã§';
            case 'INCORRECT': return '‚ùå ÌãÄÎ†∏ÏäµÎãàÎã§';
            case 'IRRELEVANT': return 'ü§∑ ÏÉÅÍ¥ÄÏóÜÏùå';
            case 'PENDING': return '‚è≥ ÎãµÎ≥Ä ÎåÄÍ∏∞Ï§ë';
            default: return answerStatus;
        }
    }

    function endGame() {
        if (connected) {
            const gameEndMessage = {
                hostUsername: currentUsername,
                roomId: currentRoomId
            };

            stompClient.send(`/topic/game/end/${currentRoomId}`, {}, JSON.stringify(gameEndMessage));
            addMessage(`üõë Í≤åÏûÑ Ï¢ÖÎ£åÎ•º ÏöîÏ≤≠ÌñàÏäµÎãàÎã§...`, 'sent');
        }
    }

    function handleGameStart(gameStartMessage) {
        console.log('Í≤åÏûÑ ÏãúÏûë!', gameStartMessage);
        gameStartTime = Date.now();
        showGameStatus();

        // Í≤åÏûÑ Ï†ïÎ≥¥Í∞Ä ÏûàÎã§Î©¥ ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
        if (gameStartMessage.gameInfo && gameStartMessage.gameInfo.data) {
            updateGameState(gameStartMessage.gameInfo.data);
        } else if (gameStartMessage.data) {
            updateGameState(gameStartMessage.data);
        }

        startGameTimer();
    }

    function handleGameEnd(gameEndMessage) {
        console.log('Í≤åÏûÑ Ï¢ÖÎ£å!', gameEndMessage);
        gameStartTime = null;
        hideGameStatus();
        clearCurrentQuestion();
    }

    function updateGameState(gameData) {
        if (gameData.currentQuestionerId) {
            currentQuestionerSpan.textContent = `ID: ${gameData.currentQuestionerId}`;
        }
        if (gameData.nextQuestioner) {
            nextQuestionerSpan.textContent = `ID: ${gameData.nextQuestioner}`;
        }
        if (gameData.remainingQuestions !== undefined) {
            remainingQuestionsSpan.textContent = gameData.remainingQuestions;
        }
    }

    function showGameStatus() {
        gameStatus.style.display = 'block';
    }

    function hideGameStatus() {
        gameStatus.style.display = 'none';
    }

    function startGameTimer() {
        setInterval(() => {
            if (gameStartTime) {
                const elapsed = Math.floor((Date.now() - gameStartTime) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                gameTimeSpan.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            }
        }, 1000);
    }

    function addMessage(message, type = 'received') {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${type}`;
        messageDiv.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
        messages.appendChild(messageDiv);
        messages.scrollTop = messages.scrollHeight;
    }

    function updateUI() {
        if (connected) {
            connectBtn.classList.add('disabled');
            disconnectBtn.classList.remove('disabled');
            sendBtn.classList.remove('disabled');
            gameStartBtn.classList.remove('disabled');
            gameEndBtn.classList.remove('disabled');
            questionBtn.classList.remove('disabled');
            correctBtn.classList.remove('disabled');
            incorrectBtn.classList.remove('disabled');
            irrelevantBtn.classList.remove('disabled');
            messageInput.disabled = false;
            questionInput.disabled = false;
            status.textContent = `Î∞© ${currentRoomId}Ïóê Ïó∞Í≤∞Îê® (ID: ${currentUserId}, Ïù¥Î¶Ñ: ${currentUsername})`;
            status.className = 'status connected';
        } else {
            connectBtn.classList.remove('disabled');
            disconnectBtn.classList.add('disabled');
            sendBtn.classList.add('disabled');
            gameStartBtn.classList.add('disabled');
            gameEndBtn.classList.add('disabled');
            questionBtn.classList.add('disabled');
            correctBtn.classList.add('disabled');
            incorrectBtn.classList.add('disabled');
            irrelevantBtn.classList.add('disabled');
            messageInput.disabled = true;
            questionInput.disabled = true;
            status.textContent = 'Ïó∞Í≤∞ÎêòÏßÄ ÏïäÏùå';
            status.className = 'status disconnected';
        }
    }

    // ÌéòÏù¥ÏßÄ Ïñ∏Î°úÎìú Ïãú Ïó∞Í≤∞ Ìï¥Ï†ú
    window.addEventListener('beforeunload', () => {
        if (connected) {
            disconnect();
        }
    });
</script>
</body>
</html>