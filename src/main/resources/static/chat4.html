<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì›¹ì†Œì¼“ ê²Œì„ í…ŒìŠ¤íŠ¸</title>
    <!-- êµ¬ë²„ì „ STOMP ë¼ì´ë¸ŒëŸ¬ë¦¬ ì‚¬ìš© -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <script>
        // ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë”© í™•ì¸
        console.log('SockJS loaded:', typeof SockJS !== 'undefined');
        console.log('Stomp loaded:', typeof Stomp !== 'undefined');
        console.log('Stomp.over available:', typeof Stomp !== 'undefined' && typeof Stomp.over === 'function');
    </script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        h1 {
            text-align: center;
            color: #4a5568;
            margin-bottom: 30px;
            font-size: 2em;
        }

        .section {
            background: #f7fafc;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #4299e1;
        }

        .game-section {
            border-left-color: #48bb78;
        }

        .question-section {
            border-left-color: #ed8936;
        }

        .answer-section {
            border-left-color: #9f7aea;
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
        }

        label {
            font-weight: bold;
            min-width: 100px;
            color: #2d3748;
        }

        input[type="text"], input[type="number"], textarea, select {
            flex: 1;
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
            font-family: inherit;
        }

        textarea {
            min-height: 80px;
            resize: vertical;
        }

        input[type="text"]:focus, input[type="number"]:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #4299e1;
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .connect-btn {
            background: #48bb78;
            color: white;
        }

        .connect-btn:hover:not(.disabled) {
            background: #38a169;
            transform: translateY(-2px);
        }

        .disconnect-btn {
            background: #f56565;
            color: white;
        }

        .disconnect-btn:hover:not(.disabled) {
            background: #e53e3e;
            transform: translateY(-2px);
        }

        .send-btn {
            background: #4299e1;
            color: white;
        }

        .send-btn:hover:not(.disabled) {
            background: #3182ce;
            transform: translateY(-2px);
        }

        .game-btn {
            background: #ed8936;
            color: white;
        }

        .game-btn:hover:not(.disabled) {
            background: #dd6b20;
            transform: translateY(-2px);
        }

        .answer-btn {
            background: #9f7aea;
            color: white;
        }

        .answer-btn:hover:not(.disabled) {
            background: #805ad5;
            transform: translateY(-2px);
        }

        .messages {
            height: 300px;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            background: white;
        }

        .message {
            padding: 8px 12px;
            margin-bottom: 8px;
            border-radius: 8px;
            animation: fadeIn 0.3s ease-in;
        }

        .message.sent {
            background: #bee3f8;
            text-align: right;
            margin-left: 50px;
        }

        .message.received {
            background: #f0fff4;
            margin-right: 50px;
        }

        .message.system {
            background: #fed7d7;
            text-align: center;
            font-style: italic;
            color: #e53e3e;
        }

        .message.game {
            background: #fef5e7;
            border-left: 4px solid #ed8936;
            font-weight: bold;
            color: #744210;
        }

        .message.question {
            background: #e6fffa;
            border-left: 4px solid #38b2ac;
            color: #234e52;
        }

        .message.answer {
            background: #faf5ff;
            border-left: 4px solid #9f7aea;
            color: #553c9a;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .status {
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-weight: bold;
            text-align: center;
        }

        .status.connected {
            background: #c6f6d5;
            color: #22543d;
        }

        .status.disconnected {
            background: #fed7d7;
            color: #742a2a;
        }

        .game-status {
            background: #e6fffa;
            border: 2px solid #38b2ac;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .game-status h4 {
            margin: 0 0 10px 0;
            color: #234e52;
        }

        .game-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            font-size: 14px;
        }

        .game-info-item {
            background: white;
            padding: 8px 12px;
            border-radius: 6px;
            border-left: 3px solid #38b2ac;
        }

        .message-form {
            display: flex;
            gap: 10px;
        }

        #messageInput {
            flex: 1;
        }

        .disabled {
            opacity: 0.5;
            pointer-events: none;
        }

        .button-row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .answer-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .answer-buttons button {
            flex: 1;
            min-width: 120px;
        }

        .correct-btn {
            background: #48bb78;
            color: white;
        }

        .incorrect-btn {
            background: #f56565;
            color: white;
        }

        .irrelevant-btn {
            background: #a0aec0;
            color: white;
        }

        .question-info {
            margin-top: 15px;
            padding: 15px;
            background: #f0f0f0;
            border-radius: 8px;
            border-left: 4px solid #38b2ac;
        }

        .question-info.active {
            background: #e6fffa;
            border-left-color: #38b2ac;
        }

        .question-info h5 {
            margin: 0 0 10px 0;
            color: #234e52;
            font-size: 14px;
        }

        .question-text {
            font-size: 13px;
            color: #2d3748;
            margin-bottom: 8px;
            padding: 8px;
            background: white;
            border-radius: 4px;
            font-style: italic;
        }

        .question-meta {
            font-size: 12px;
            color: #666;
        }

        @media (max-width: 768px) {
            .two-column {
                grid-template-columns: 1fr;
            }

            .button-row, .answer-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
<div class="container">
    <h1>ğŸ® ì›¹ì†Œì¼“ ê²Œì„ í…ŒìŠ¤íŠ¸</h1>

    <div class="section">
        <h3>ì—°ê²° ì„¤ì •</h3>
        <div class="input-group">
            <label>ì„œë²„ URL:</label>
            <input type="text" id="serverUrl" value="http://localhost:8080/ws" placeholder="ì›¹ì†Œì¼“ ì„œë²„ URL">
        </div>
        <div class="input-group">
            <label>ë°© ID:</label>
            <input type="number" id="roomId" value="1" placeholder="ë°© ID">
        </div>
        <div class="input-group">
            <label>ì‚¬ìš©ì ID:</label>
            <input type="number" id="userId" value="1" placeholder="ì‚¬ìš©ì ID (ìˆ«ì)">
        </div>
        <div class="input-group">
            <label>ì‚¬ìš©ìëª…:</label>
            <input type="text" id="username" value="í…ŒìŠ¤í„°1" placeholder="ì‚¬ìš©ìëª… (í‘œì‹œìš©)">
        </div>
        <div class="button-row">
            <button id="connectBtn" class="connect-btn">ğŸ”— ì—°ê²°</button>
            <button id="disconnectBtn" class="disconnect-btn disabled">âŒ ì—°ê²° í•´ì œ</button>
        </div>
    </div>

    <div id="status" class="status disconnected">ì—°ê²°ë˜ì§€ ì•ŠìŒ</div>

    <div id="gameStatus" class="game-status" style="display: none;">
        <h4>ğŸ® ê²Œì„ ìƒíƒœ</h4>
        <div class="game-info">
            <div class="game-info-item">
                <strong>í˜„ì¬ ì§ˆë¬¸ì:</strong> <span id="currentQuestioner">-</span>
            </div>
            <div class="game-info-item">
                <strong>ë‹¤ìŒ ì§ˆë¬¸ì:</strong> <span id="nextQuestioner">-</span>
            </div>
            <div class="game-info-item">
                <strong>ë‚¨ì€ ì§ˆë¬¸:</strong> <span id="remainingQuestions">-</span>
            </div>
            <div class="game-info-item">
                <strong>ê²Œì„ ì‹œê°„:</strong> <span id="gameTime">-</span>
            </div>
        </div>
    </div>

    <div class="two-column">
        <div class="section">
            <h3>ğŸ’¬ ì±„íŒ… ë° ë©”ì‹œì§€</h3>
            <div id="messages" class="messages"></div>
            <div class="message-form">
                <input type="text" id="messageInput" placeholder="ì±„íŒ… ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." disabled>
                <button id="sendBtn" class="send-btn disabled">ì „ì†¡</button>
            </div>
        </div>

        <div class="section game-section">
            <h3>ğŸ® ê²Œì„ ì œì–´</h3>
            <div class="button-row">
                <button id="gameStartBtn" class="game-btn disabled">ğŸš€ ê²Œì„ ì‹œì‘</button>
                <button id="gameEndBtn" class="disconnect-btn disabled">ğŸ›‘ ê²Œì„ ì¢…ë£Œ</button>
            </div>

            <div class="section question-section" style="margin-top: 20px;">
                <h4>â“ ì§ˆë¬¸ ì œì¶œ</h4>
                <div class="input-group">
                    <label>ì§ˆë¬¸:</label>
                    <textarea id="questionInput" placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”..." disabled rows="3"></textarea>
                </div>
                <button id="questionBtn" class="game-btn disabled">ğŸ“ ì§ˆë¬¸ ì œì¶œ</button>
            </div>

            <div class="section answer-section" style="margin-top: 20px;">
                <h4>ğŸ’¬ ë‹µë³€ ì œì¶œ (ì¶œì œì ì „ìš©)</h4>
                <p style="font-size: 12px; color: #666; margin-bottom: 15px;">
                    ë°›ì€ ì§ˆë¬¸ì— ëŒ€í•´ ë‹µë³€í•˜ì„¸ìš”. ë‹µë³€í•  ì§ˆë¬¸ì´ ì•„ë˜ì— í‘œì‹œë©ë‹ˆë‹¤.
                </p>

                <div id="questionInfo" class="question-info">
                    <h5>ğŸ“‹ ë‹µë³€í•  ì§ˆë¬¸</h5>
                    <div id="questionDisplay" class="question-text">ì§ˆë¬¸ì´ ì—†ìŠµë‹ˆë‹¤</div>
                    <div id="questionMeta" class="question-meta">ì§ˆë¬¸ì: - | ì‹œê°„: -</div>
                </div>

                <div class="answer-buttons">
                    <button id="correctBtn" class="answer-btn correct-btn disabled">âœ… ë§ìŠµë‹ˆë‹¤</button>
                    <button id="incorrectBtn" class="answer-btn incorrect-btn disabled">âŒ í‹€ë ¸ìŠµë‹ˆë‹¤</button>
                    <button id="irrelevantBtn" class="answer-btn irrelevant-btn disabled">ğŸ¤· ìƒê´€ì—†ìŒ</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let stompClient = null;
    let connected = false;
    let currentRoomId = null;
    let currentUserId = null;
    let currentUsername = null;
    let gameStartTime = null;

    // ì§ˆë¬¸-ë‹µë³€ ì—°ë™ì„ ìœ„í•œ ë³€ìˆ˜ë“¤
    let currentQuestion = null;  // í˜„ì¬ ë‹µë³€í•´ì•¼ í•  ì§ˆë¬¸ ì •ë³´

    // DOM ìš”ì†Œë“¤
    const connectBtn = document.getElementById('connectBtn');
    const disconnectBtn = document.getElementById('disconnectBtn');
    const sendBtn = document.getElementById('sendBtn');
    const gameStartBtn = document.getElementById('gameStartBtn');
    const gameEndBtn = document.getElementById('gameEndBtn');
    const questionBtn = document.getElementById('questionBtn');
    const correctBtn = document.getElementById('correctBtn');
    const incorrectBtn = document.getElementById('incorrectBtn');
    const irrelevantBtn = document.getElementById('irrelevantBtn');
    const messageInput = document.getElementById('messageInput');
    const questionInput = document.getElementById('questionInput');
    const messages = document.getElementById('messages');
    const status = document.getElementById('status');
    const gameStatus = document.getElementById('gameStatus');

    // ì§ˆë¬¸ ì •ë³´ í‘œì‹œ ìš”ì†Œë“¤
    const questionInfo = document.getElementById('questionInfo');
    const questionDisplay = document.getElementById('questionDisplay');
    const questionMeta = document.getElementById('questionMeta');

    // ê²Œì„ ìƒíƒœ ìš”ì†Œë“¤
    const currentQuestionerSpan = document.getElementById('currentQuestioner');
    const nextQuestionerSpan = document.getElementById('nextQuestioner');
    const remainingQuestionsSpan = document.getElementById('remainingQuestions');
    const gameTimeSpan = document.getElementById('gameTime');

    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    connectBtn.addEventListener('click', connect);
    disconnectBtn.addEventListener('click', disconnect);
    sendBtn.addEventListener('click', sendMessage);
    gameStartBtn.addEventListener('click', startGame);
    gameEndBtn.addEventListener('click', endGame);
    questionBtn.addEventListener('click', sendQuestion);
    correctBtn.addEventListener('click', () => sendAnswer('CORRECT'));
    incorrectBtn.addEventListener('click', () => sendAnswer('INCORRECT'));
    irrelevantBtn.addEventListener('click', () => sendAnswer('IRRELEVANT'));

    messageInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });

    questionInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && e.ctrlKey) {
            sendQuestion();
        }
    });

    function connect() {
        // ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë”© í™•ì¸
        if (typeof SockJS === 'undefined') {
            addMessage('SockJS ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.', 'system');
            return;
        }

        if (typeof Stomp === 'undefined') {
            addMessage('Stomp ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.', 'system');
            return;
        }

        const serverUrl = document.getElementById('serverUrl').value;
        const roomId = document.getElementById('roomId').value;
        const userId = document.getElementById('userId').value;
        const username = document.getElementById('username').value;

        if (!serverUrl || !roomId || !userId || !username) {
            alert('ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!');
            return;
        }

        currentRoomId = roomId;
        currentUserId = parseInt(userId);
        currentUsername = username;

        addMessage(`${serverUrl}ì— ì—°ê²° ì‹œë„ ì¤‘...`, 'system');

        try {
            const socket = new SockJS(serverUrl);
            stompClient = Stomp.over(socket);

            // ë””ë²„ê·¸ ì„¤ì •
            stompClient.debug = function(str) {
                if (str.includes('Connected') || str.includes('ERROR') || str.includes('DISCONNECT')) {
                    console.log('STOMP: ' + str);
                }
            };

            // í•˜íŠ¸ë¹„íŠ¸ ì„¤ì •
            stompClient.heartbeat.outgoing = 20000;
            stompClient.heartbeat.incoming = 20000;

            // STOMP ì—°ê²°
            stompClient.connect({
                    userId: currentUserId.toString(), // âœ… userIdë¥¼ í—¤ë”ì— ë‹´ì•„ ì„œë²„ë¡œ ì „ë‹¬
                    'user-id': currentUserId.toString(), // ë‹¤ë¥¸ í˜•íƒœë¡œë„ ì‹œë„
                    'X-User-Id': currentUserId.toString() // í—¤ë” í˜•íƒœë¡œë„ ì‹œë„
                },
                function(frame) {
                    console.log('STOMP Connected: ' + frame);
                    console.log('ì—°ê²°ëœ ì‚¬ìš©ì ID:', currentUserId);
                    console.log('ì—°ê²° í—¤ë”:', frame.headers);
                    connected = true;
                    updateUI();
                    addMessage(`ë°© ${roomId}ì— ì—°ê²° ì„±ê³µ!`, 'system');
                    subscribeToChannels();
                },
                function(error) {
                    console.log('STOMP Connection error: ', error);
                    addMessage('STOMP ì—°ê²° ì‹¤íŒ¨: ' + (error.headers ? error.headers.message : error), 'system');
                    connected = false;
                    updateUI();
                }
            );

        } catch (error) {
            console.error('ì—°ê²° ì¤‘ ì—ëŸ¬:', error);
            addMessage('ì—°ê²° ì¤‘ ì—ëŸ¬: ' + error.message, 'system');
            connected = false;
            updateUI();
        }
    }

    function subscribeToChannels() {
        try {
            // ì±„íŒ… êµ¬ë…
            stompClient.subscribe(`/topic/chat/${currentRoomId}`, function(message) {
                const chatMessage = JSON.parse(message.body);
                const messageType = chatMessage.username === currentUsername ? 'sent' : 'received';
                addMessage(`${chatMessage.username}: ${chatMessage.content}`, messageType);
            });

            // ê²Œì„ ì‹œì‘ ì•Œë¦¼ êµ¬ë…
            stompClient.subscribe(`/topic/game/${currentRoomId}/game-started`, function(message) {
                const gameStartMessage = JSON.parse(message.body);
                addMessage(`ğŸ® ê²Œì„ ì‹œì‘! ${gameStartMessage.message || 'ê²Œì„ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!'}`, 'game');
                handleGameStart(gameStartMessage);
            });

            // ê²Œì„ ì¢…ë£Œ ì•Œë¦¼ êµ¬ë…
            stompClient.subscribe(`/topic/game/end/${currentRoomId}`, function(message) {
                const gameEndMessage = JSON.parse(message.body);
                addMessage(`ğŸ›‘ ê²Œì„ ì¢…ë£Œ: ${gameEndMessage.message}`, 'game');
                handleGameEnd(gameEndMessage);
            });

            // ì§ˆë¬¸ ì „ì†¡ ì„±ê³µ ì•Œë¦¼ êµ¬ë… - ë‹¤ì–‘í•œ ê²½ë¡œ ì‹œë„í•´ì„œ ì–´ë–¤ ê²½ë¡œë¡œ ì˜¤ëŠ”ì§€ í™•ì¸
            console.log('êµ¬ë… ì‹œì‘ - í˜„ì¬ ì‚¬ìš©ì ID:', currentUserId, 'ë°© ID:', currentRoomId);

            // 1. í‘œì¤€ user ê²½ë¡œ
            stompClient.subscribe(`/user/topic/game/${currentRoomId}/question-send`, function(message) {
                const questionResponse = JSON.parse(message.body);
                console.log('!!!!!!!ì§ˆë¬¸ ê´€ë ¨ ë‚´ìš© (user ê²½ë¡œ)', questionResponse);
                addMessage(`âœ… ì§ˆë¬¸ì´ ì„±ê³µì ìœ¼ë¡œ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤! (user ê²½ë¡œ)`, 'system');
            });

            // 2. user queue ê²½ë¡œ (ë•Œë¡œëŠ” ì´ë ‡ê²Œ ì˜¬ ìˆ˜ë„ ìˆìŒ)
            stompClient.subscribe(`/user/queue/topic/game/${currentRoomId}/question-send`, function(message) {
                const questionResponse = JSON.parse(message.body);
                console.log('!!!!!!!ì§ˆë¬¸ ê´€ë ¨ ë‚´ìš© (queue ê²½ë¡œ)', questionResponse);
                addMessage(`âœ… ì§ˆë¬¸ì´ ì„±ê³µì ìœ¼ë¡œ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤! (queue ê²½ë¡œ)`, 'system');
            });

            // 3. ì§ì ‘ì ì¸ topic ê²½ë¡œ (í˜¹ì‹œ ë¸Œë¡œë“œìºìŠ¤íŠ¸ë¡œ ì˜¤ëŠ” ê²½ìš°)
            stompClient.subscribe(`/topic/game/${currentRoomId}/question-send`, function(message) {
                const questionResponse = JSON.parse(message.body);
                console.log('!!!!!!!ì§ˆë¬¸ ê´€ë ¨ ë‚´ìš© (topic ê²½ë¡œ)', questionResponse);
                addMessage(`âœ… ì§ˆë¬¸ì´ ì„±ê³µì ìœ¼ë¡œ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤! (topic ê²½ë¡œ)`, 'system');
            });

            // ë‹µë³€ ì „ì†¡ ì„±ê³µ ì•Œë¦¼ êµ¬ë… - ë‹¤ì–‘í•œ ê²½ë¡œ ì‹œë„
            // 1. í‘œì¤€ user ê²½ë¡œ
            stompClient.subscribe(`/user/topic/game/${currentRoomId}/answer-send`, function(message) {
                const answerResponse = JSON.parse(message.body);
                console.log('ë‹µë³€ ì „ì†¡ ì„±ê³µ (user ê²½ë¡œ)', answerResponse);
                addMessage(`âœ… ë‹µë³€ì´ ì„±ê³µì ìœ¼ë¡œ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤! (user ê²½ë¡œ)`, 'system');
                clearCurrentQuestion();
            });

            // 2. user queue ê²½ë¡œ
            stompClient.subscribe(`/user/queue/topic/game/${currentRoomId}/answer-send`, function(message) {
                const answerResponse = JSON.parse(message.body);
                console.log('ë‹µë³€ ì „ì†¡ ì„±ê³µ (queue ê²½ë¡œ)', answerResponse);
                addMessage(`âœ… ë‹µë³€ì´ ì„±ê³µì ìœ¼ë¡œ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤! (queue ê²½ë¡œ)`, 'system');
                clearCurrentQuestion();
            });

            // 3. ì§ì ‘ì ì¸ topic ê²½ë¡œ
            stompClient.subscribe(`/topic/game/${currentRoomId}/answer-send`, function(message) {
                const answerResponse = JSON.parse(message.body);
                console.log('ë‹µë³€ ì „ì†¡ ì„±ê³µ (topic ê²½ë¡œ)', answerResponse);
                addMessage(`âœ… ë‹µë³€ì´ ì„±ê³µì ìœ¼ë¡œ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤! (topic ê²½ë¡œ)`, 'system');
                clearCurrentQuestion();
            });

            // ì§ˆë¬¸ ë¸Œë¡œë“œìºìŠ¤íŠ¸ êµ¬ë… (ëª¨ë“  ì°¸ì—¬ììš©)
            stompClient.subscribe(`/topic/game/${currentRoomId}/chat`, function(message) {
                const gameMessage = JSON.parse(message.body);

                if (gameMessage.type === 'question') {
                    const questionData = gameMessage.data;
                    const questionText = questionData.questionRequestDto.message;
                    const questionerId = questionData.questionRequestDto.senderId;

                    addMessage(`â“ ì§ˆë¬¸: ${questionText}`, 'question');

                    // ì¶œì œìì¸ ê²½ìš° ì§ˆë¬¸ ì •ë³´ ì €ì¥
                    if (questionData.hostId === currentUserId) {
                        setCurrentQuestion(questionText, questionerId);
                        addMessage(`ğŸ“‹ ìƒˆë¡œìš´ ì§ˆë¬¸ì´ ë„ì°©í–ˆìŠµë‹ˆë‹¤! ë‹µë³€ ì„¹ì…˜ì„ í™•ì¸í•˜ì„¸ìš”.`, 'system');
                    }

                    updateGameState(questionData);
                } else if (gameMessage.type === 'answer') {
                    const answerData = gameMessage.data;
                    const answerText = getAnswerText(answerData.answerResponseDto.message);
                    addMessage(`ğŸ’¬ ë‹µë³€: ${answerText}`, 'answer');
                    updateGameState(answerData);
                }
            });

            // ì—ëŸ¬ ë©”ì‹œì§€ êµ¬ë…
            stompClient.subscribe(`/sub/user/${currentUserId}/error`, function(message) {
                const errorMessage = JSON.parse(message.body);
                addMessage(`âŒ ì—ëŸ¬: ${errorMessage.message || errorMessage}`, 'system');
            });

            addMessage('ëª¨ë“  ì±„ë„ êµ¬ë… ì™„ë£Œ', 'system');

        } catch (error) {
            console.error('êµ¬ë… ì¤‘ ì—ëŸ¬:', error);
            addMessage('êµ¬ë… ì‹¤íŒ¨: ' + error.message, 'system');
        }
    }

    function disconnect() {
        if (stompClient !== null && connected) {
            stompClient.disconnect();
            addMessage('ì—°ê²°ì´ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'system');
        }
        connected = false;
        gameStartTime = null;
        currentQuestion = null;  // ì§ˆë¬¸ ì •ë³´ ì´ˆê¸°í™”
        updateUI();
        hideGameStatus();
        clearCurrentQuestion();
    }

    function sendMessage() {
        const messageContent = messageInput.value.trim();
        if (messageContent && connected) {
            const chatMessage = {
                username: currentUsername,
                content: messageContent
            };

            stompClient.send(`/topic/chat/${currentRoomId}`, {}, JSON.stringify(chatMessage));
            messageInput.value = '';
        }
    }

    function startGame() {
        if (currentRoomId && currentUserId) {
            addMessage(`ğŸ® ê²Œì„ ì‹œì‘ì„ ìš”ì²­í•©ë‹ˆë‹¤...`, 'sent');

            try {
                stompClient.send(
                    `/app/game/${currentRoomId}/start`
                );
                addMessage(`âœ… ê²Œì„ ì‹œì‘ ìš”ì²­ì„ ì„œë²„ë¡œ ì „ì†¡í–ˆìŠµë‹ˆë‹¤.`, 'system');
            } catch (error) {
                console.error('ê²Œì„ ì‹œì‘ ë©”ì‹œì§€ ì „ì†¡ ì¤‘ ì˜¤ë¥˜:', error);
                addMessage(`âŒ ê²Œì„ ì‹œì‘ ìš”ì²­ ì‹¤íŒ¨: ${error.message}`, 'system');
            }
        }
    }

    function sendQuestion() {
        const questionContent = questionInput.value.trim();
        if (!questionContent) {
            alert('ì§ˆë¬¸ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!');
            return;
        }

        if (!connected) {
            alert('ë¨¼ì € ì›¹ì†Œì¼“ì— ì—°ê²°í•´ì£¼ì„¸ìš”!');
            return;
        }

        addMessage(`ğŸ“ ì§ˆë¬¸ ì œì¶œ: "${questionContent}"`, 'sent');

        try {
            stompClient.send(
                `/app/game/${currentRoomId}/question`,
                {},
                questionContent // Stringì„ ì§ì ‘ ì „ì†¡
            );
            questionInput.value = '';
            addMessage(`âœ… ì§ˆë¬¸ì„ ì„œë²„ë¡œ ì „ì†¡í–ˆìŠµë‹ˆë‹¤.`, 'system');
        } catch (error) {
            console.error('ì§ˆë¬¸ ì „ì†¡ ì¤‘ ì˜¤ë¥˜:', error);
            addMessage(`âŒ ì§ˆë¬¸ ì „ì†¡ ì‹¤íŒ¨: ${error.message}`, 'system');
        }
    }

    function sendAnswer(answerStatus) {
        if (!connected) {
            alert('ë¨¼ì € ì›¹ì†Œì¼“ì— ì—°ê²°í•´ì£¼ì„¸ìš”!');
            return;
        }

        if (!currentQuestion) {
            alert('ë‹µë³€í•  ì§ˆë¬¸ì´ ì—†ìŠµë‹ˆë‹¤!');
            return;
        }

        const answerText = getAnswerText(answerStatus);
        addMessage(`ğŸ’¬ ë‹µë³€ ì œì¶œ: "${answerText}" (ì§ˆë¬¸: "${currentQuestion.question}")`, 'sent');

        try {
            // AnswerRequestDto í˜•íƒœë¡œ ì „ì†¡
            const answerRequest = {
                questionerId: currentQuestion.questionerId,
                question: currentQuestion.question,
                answer: answerStatus
            };

            console.log('ë‹µë³€ ìš”ì²­ ë°ì´í„°:', answerRequest);

            stompClient.send(
                `/app/game/${currentRoomId}/answer`,
                {},
                JSON.stringify(answerRequest)
            );
            addMessage(`âœ… ë‹µë³€ì„ ì„œë²„ë¡œ ì „ì†¡í–ˆìŠµë‹ˆë‹¤.`, 'system');
        } catch (error) {
            console.error('ë‹µë³€ ì „ì†¡ ì¤‘ ì˜¤ë¥˜:', error);
            addMessage(`âŒ ë‹µë³€ ì „ì†¡ ì‹¤íŒ¨: ${error.message}`, 'system');
        }
    }

    function setCurrentQuestion(questionText, questionerId) {
        currentQuestion = {
            question: questionText,
            questionerId: questionerId,
            receivedAt: new Date()
        };
        updateQuestionDisplay();
        console.log('ì§ˆë¬¸ ì •ë³´ ì €ì¥:', currentQuestion);
    }

    function clearCurrentQuestion() {
        currentQuestion = null;
        updateQuestionDisplay();
    }

    function updateQuestionDisplay() {
        if (currentQuestion) {
            questionDisplay.textContent = `"${currentQuestion.question}"`;
            questionMeta.textContent = `ì§ˆë¬¸ì ID: ${currentQuestion.questionerId} | ì‹œê°„: ${currentQuestion.receivedAt.toLocaleTimeString()}`;
            questionInfo.classList.add('active');
        } else {
            questionDisplay.textContent = 'ì§ˆë¬¸ì´ ì—†ìŠµë‹ˆë‹¤';
            questionMeta.textContent = 'ì§ˆë¬¸ì: - | ì‹œê°„: -';
            questionInfo.classList.remove('active');
        }
    }

    function getAnswerText(answerStatus) {
        switch(answerStatus) {
            case 'CORRECT': return 'âœ… ë§ìŠµë‹ˆë‹¤';
            case 'INCORRECT': return 'âŒ í‹€ë ¸ìŠµë‹ˆë‹¤';
            case 'IRRELEVANT': return 'ğŸ¤· ìƒê´€ì—†ìŒ';
            case 'PENDING': return 'â³ ë‹µë³€ ëŒ€ê¸°ì¤‘';
            default: return answerStatus;
        }
    }

    function endGame() {
        if (connected) {
            const gameEndMessage = {
                hostUsername: currentUsername,
                roomId: currentRoomId
            };

            stompClient.send(`/topic/game/end/${currentRoomId}`, {}, JSON.stringify(gameEndMessage));
            addMessage(`ğŸ›‘ ê²Œì„ ì¢…ë£Œë¥¼ ìš”ì²­í–ˆìŠµë‹ˆë‹¤...`, 'sent');
        }
    }

    function handleGameStart(gameStartMessage) {
        console.log('ê²Œì„ ì‹œì‘!', gameStartMessage);
        gameStartTime = Date.now();
        showGameStatus();

        // ê²Œì„ ì •ë³´ê°€ ìˆë‹¤ë©´ ìƒíƒœ ì—…ë°ì´íŠ¸
        if (gameStartMessage.gameInfo && gameStartMessage.gameInfo.data) {
            updateGameState(gameStartMessage.gameInfo.data);
        } else if (gameStartMessage.data) {
            updateGameState(gameStartMessage.data);
        }

        startGameTimer();
    }

    function handleGameEnd(gameEndMessage) {
        console.log('ê²Œì„ ì¢…ë£Œ!', gameEndMessage);
        gameStartTime = null;
        hideGameStatus();
        clearCurrentQuestion();
    }

    function updateGameState(gameData) {
        if (gameData.currentQuestionerId) {
            currentQuestionerSpan.textContent = `ID: ${gameData.currentQuestionerId}`;
        }
        if (gameData.nextQuestioner) {
            nextQuestionerSpan.textContent = `ID: ${gameData.nextQuestioner}`;
        }
        if (gameData.remainingQuestions !== undefined) {
            remainingQuestionsSpan.textContent = gameData.remainingQuestions;
        }
    }

    function showGameStatus() {
        gameStatus.style.display = 'block';
    }

    function hideGameStatus() {
        gameStatus.style.display = 'none';
    }

    function startGameTimer() {
        setInterval(() => {
            if (gameStartTime) {
                const elapsed = Math.floor((Date.now() - gameStartTime) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                gameTimeSpan.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            }
        }, 1000);
    }

    function addMessage(message, type = 'received') {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${type}`;
        messageDiv.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
        messages.appendChild(messageDiv);
        messages.scrollTop = messages.scrollHeight;
    }

    function updateUI() {
        if (connected) {
            connectBtn.classList.add('disabled');
            disconnectBtn.classList.remove('disabled');
            sendBtn.classList.remove('disabled');
            gameStartBtn.classList.remove('disabled');
            gameEndBtn.classList.remove('disabled');
            questionBtn.classList.remove('disabled');
            correctBtn.classList.remove('disabled');
            incorrectBtn.classList.remove('disabled');
            irrelevantBtn.classList.remove('disabled');
            messageInput.disabled = false;
            questionInput.disabled = false;
            status.textContent = `ë°© ${currentRoomId}ì— ì—°ê²°ë¨ (ID: ${currentUserId}, ì´ë¦„: ${currentUsername})`;
            status.className = 'status connected';
        } else {
            connectBtn.classList.remove('disabled');
            disconnectBtn.classList.add('disabled');
            sendBtn.classList.add('disabled');
            gameStartBtn.classList.add('disabled');
            gameEndBtn.classList.add('disabled');
            questionBtn.classList.add('disabled');
            correctBtn.classList.add('disabled');
            incorrectBtn.classList.add('disabled');
            irrelevantBtn.classList.add('disabled');
            messageInput.disabled = true;
            questionInput.disabled = true;
            status.textContent = 'ì—°ê²°ë˜ì§€ ì•ŠìŒ';
            status.className = 'status disconnected';
        }
    }

    // í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ ì—°ê²° í•´ì œ
    window.addEventListener('beforeunload', () => {
        if (connected) {
            disconnect();
        }
    });
</script>
</body>
</html>